<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ— äººæœºæ•°æ®é‡‡é›†æ§åˆ¶å°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card-stat { transition: all 0.3s; }
        .val-box { font-size: 2.5rem; font-weight: bold; }
        .status-dot { height: 15px; width: 15px; background-color: #bbb; border-radius: 50%; display: inline-block; }
        .online { background-color: #28a745; box-shadow: 0 0 10px #28a745; }
        .recording { animation: blink 1s infinite; background-color: #dc3545; }
        @keyframes blink { 50% { opacity: 0.5; } }
        .card { border: none; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="p-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>ğŸ›¸ æ— äººæœºé›†ç¾¤æ•°æ®é‡‡é›†ç³»ç»Ÿ</h2>
            <div>
                <span id="connStatus" class="badge bg-secondary me-2">Pythonç¦»çº¿</span>
                <span class="status-dot" id="recDot"></span>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card shadow-sm p-3 text-center">
                    <div class="text-muted">å‰©ä½™æœªä¾¦å¯Ÿ (Value Sum)</div>
                    <div class="val-box text-danger" id="valSum">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm p-3 text-center">
                    <div class="text-muted">è¦†ç›–ç‡ (Coverage)</div>
                    <div class="val-box text-success"><span id="valCov">0.0</span>%</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm p-3 text-center">
                    <div class="text-muted">å·²ä¾¦å¯Ÿæ …æ ¼</div>
                    <div class="val-box text-primary" id="valScanned">0</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card shadow-sm p-3 text-center">
                    <div class="text-muted">ä»»åŠ¡æ—¶é•¿</div>
                    <div class="val-box" id="valTime">0.0s</div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card shadow-sm p-3">
                    <h5>å®æ—¶è¦†ç›–ç‡è¶‹åŠ¿</h5>
                    <canvas id="chartCov" height="100"></canvas>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card shadow-sm p-3 h-100">
                    <h5>é‡‡é›†æ§åˆ¶</h5>
                    <div class="d-grid gap-2 mt-3">
                        <button class="btn btn-success btn-lg" id="btnStart" onclick="startRec()">å¼€å§‹é‡‡é›†</button>
                        <button class="btn btn-danger btn-lg" id="btnStop" onclick="stopRec()" disabled>åœæ­¢å¹¶ä¿å­˜</button>
                    </div>
                    <hr>
                    <h5>æœ€è¿‘ç”Ÿæˆçš„æ–‡ä»¶</h5>
                    <div class="list-group list-group-flush small" id="fileList" style="max-height: 200px; overflow-y: auto;">
                    </div>
                    <button class="btn btn-sm btn-outline-secondary mt-2" onclick="refreshFiles()">åˆ·æ–°åˆ—è¡¨</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const ctx = document.getElementById('chartCov').getContext('2d');
        
        // åˆå§‹åŒ–å›¾è¡¨
        const chart = new Chart(ctx, {
            type: 'line',
            data: { 
                labels: [], 
                datasets: [{ 
                    label: 'è¦†ç›–ç‡ %', 
                    data: [], 
                    borderColor: '#198754', 
                    tension: 0.1, 
                    fill: true, 
                    backgroundColor: 'rgba(25, 135, 84, 0.1)' 
                }] 
            },
            options: { 
                animation: false, 
                responsive: true,
                maintainAspectRatio: true,
                scales: { 
                    y: { 
                        min: 0, 
                        max: 100 
                    },
                    x: {
                        display: true,
                        title: {
                            display: true,
                            text: 'æ—¶é—´ (ç§’)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        display: true
                    }
                }
            } 
        });

        // çŠ¶æ€æ›´æ–°
        socket.on('web_telemetry', (data) => {
            document.getElementById('connStatus').className = 'badge bg-success me-2';
            document.getElementById('connStatus').innerText = 'Pythonåœ¨çº¿';
            
            document.getElementById('valSum').innerText = data.unscanned || 0;
            document.getElementById('valCov').innerText = (data.coverage || 0).toFixed(1);
            document.getElementById('valScanned').innerText = data.scanned || 0;
            document.getElementById('valTime').innerText = (data.time || 0).toFixed(1) + 's';

            // æ›´æ–°å›¾è¡¨ (é™åˆ¶æ•°æ®ç‚¹æ•°é‡)
            if (data.recording) {
                const timeLabel = (data.time || 0).toFixed(1);
                chart.data.labels.push(timeLabel);
                chart.data.datasets[0].data.push(data.coverage || 0);
                if(chart.data.labels.length > 50) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                }
                chart.update('none'); // ç¦ç”¨åŠ¨ç”»ä»¥æé«˜æ€§èƒ½
            }
            updateRecState(data.recording);
        });

        socket.on('web_file_saved', (filename) => {
            alert(`æ•°æ®å·²ä¿å­˜: ${filename}`);
            refreshFiles();
        });

        socket.on('file_list', (files) => {
            const list = document.getElementById('fileList');
            list.innerHTML = '';
            if (files.length === 0) {
                list.innerHTML = '<div class="list-group-item text-muted">æš‚æ— æ–‡ä»¶</div>';
                return;
            }
            files.forEach(f => {
                const item = document.createElement('a');
                item.href = `/logs/${f.name}`;
                item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
                item.innerHTML = `<span>ğŸ“„ ${f.name}</span> <span class="badge bg-light text-dark">â¬‡ï¸</span>`;
                item.target = '_blank';
                list.appendChild(item);
            });
        });

        socket.on('status_update', (status) => {
            if (status.connected) {
                document.getElementById('connStatus').className = 'badge bg-success me-2';
                document.getElementById('connStatus').innerText = 'Pythonåœ¨çº¿';
                updateRecState(status.recording);
            }
        });

        function startRec() { 
            socket.emit('cmd_start_record'); 
        }
        
        function stopRec() { 
            socket.emit('cmd_stop_record'); 
        }
        
        function refreshFiles() { 
            socket.emit('get_file_list'); 
        }

        function updateRecState(isRec) {
            const dot = document.getElementById('recDot');
            const btnStart = document.getElementById('btnStart');
            const btnStop = document.getElementById('btnStop');
            
            if (isRec) {
                dot.classList.add('recording', 'online');
                dot.classList.remove('online');
                dot.classList.add('recording');
                btnStart.disabled = true;
                btnStop.disabled = false;
            } else {
                dot.classList.remove('recording');
                if (!dot.classList.contains('online')) {
                    dot.classList.add('online');
                }
                btnStart.disabled = false;
                btnStop.disabled = true;
            }
        }

        // åˆå§‹åŠ è½½
        refreshFiles();
        
        // å®šæœŸåˆ·æ–°æ–‡ä»¶åˆ—è¡¨
        setInterval(refreshFiles, 5000);
    </script>
</body>
</html>

