# 重置仿真按钮功能说明

**功能版本**: v1.0  
**添加日期**: 2025-10-13  
**状态**: ✅ 已完成

---

## 🎯 功能概述

在2D可视化窗口中添加了一个"重置仿真"按钮，用户点击后可以同时重置AirSim和Unity环境，实现完整的仿真环境重置。

---

## 🔧 技术实现

### 1. 可视化界面增强

#### 按钮设计
- **位置**: 右上角，熵值图例下方
- **尺寸**: 120x35像素
- **颜色**: 红色主题，悬停时变亮
- **文字**: "重置仿真"

#### 交互效果
- **悬停效果**: 鼠标悬停时按钮变亮
- **点击反馈**: 点击后立即执行重置操作
- **状态提示**: 控制台输出详细的重置过程信息

### 2. 事件处理系统

#### 鼠标事件处理
```python
def _handle_mouse_click(self, pos):
    """处理鼠标点击事件"""
    if hasattr(self, 'reset_button_rect') and self.reset_button_rect.collidepoint(pos):
        self._handle_reset_button_click()
```

#### 重置按钮点击处理
```python
def _handle_reset_button_click(self):
    """处理重置按钮点击"""
    if hasattr(self.server, 'reset_simulation'):
        success = self.server.reset_simulation()
        if success:
            print("[重置] ✅ 仿真重置成功")
        else:
            print("[重置] ❌ 仿真重置失败")
```

---

## 🚀 重置功能流程

### 完整重置步骤

当用户点击"重置仿真"按钮时，系统会执行以下步骤：

#### 步骤1: 发送Unity重置命令
- 通过Unity Socket服务器发送 `reset_env` 数据包
- Unity客户端接收到命令后重置场景状态

#### 步骤2: 重置AirSim模拟器
- 调用AirSim API的 `reset()` 方法
- 重置所有无人机状态和位置
- 清理AirSim内部状态

#### 步骤3: 清理本地数据
- 重置运行时数据存储
- 清理网格数据
- 重新创建算法实例

#### 步骤4: 重新初始化无人机
- 启用API控制
- 解锁无人机
- 起飞到初始位置

#### 步骤5: 发送配置数据
- 重新发送算法配置到Unity
- 确保Unity和Python端配置同步

---

## 📋 代码文件修改

### 1. `simple_visualizer.py`

#### 新增方法
- `draw_reset_button()` - 绘制重置按钮
- `_handle_mouse_click()` - 处理鼠标点击
- `_handle_reset_button_click()` - 处理重置按钮点击

#### 修改方法
- `handle_events()` - 添加鼠标事件处理
- `draw_instructions()` - 更新操作说明

### 2. `AlgorithmServer.py`

#### 新增方法
- `reset_simulation()` - 主要重置功能
- `_clear_local_data()` - 清理本地数据

---

## 🎮 使用方法

### 基本操作
1. **启动系统**: 运行批处理文件启动算法服务器
2. **打开可视化**: 系统自动启动2D可视化窗口
3. **点击重置**: 点击右上角的红色"重置仿真"按钮
4. **查看反馈**: 观察控制台输出的重置过程信息

### 重置时机
- 仿真环境出现异常时
- 需要重新开始实验时
- 无人机状态混乱时
- 网格数据需要清理时

---

## 📊 功能特性

### ✅ 已实现功能

| 功能 | 状态 | 说明 |
|------|------|------|
| 按钮UI | ✅ | 红色按钮，悬停效果 |
| 点击检测 | ✅ | 鼠标左键点击检测 |
| Unity重置 | ✅ | 发送重置命令到Unity |
| AirSim重置 | ✅ | 调用AirSim API重置 |
| 数据清理 | ✅ | 清理本地运行时数据 |
| 无人机重初始化 | ✅ | 重新起飞和配置 |
| 配置同步 | ✅ | 重新发送配置数据 |
| 状态反馈 | ✅ | 控制台详细日志 |

### 🔄 重置范围

#### Unity端重置
- 场景状态重置
- 网格数据清理
- 可视化状态重置

#### AirSim端重置
- 无人机位置重置
- 物理状态重置
- API控制状态重置

#### Python端重置
- 运行时数据清理
- 算法实例重建
- 网格数据重置

---

## 🛠️ 技术细节

### 通信协议

#### 重置命令数据包
```json
{
    "type": "reset_env",
    "time_span": "1697123456.789",
    "pack_data_list": {}
}
```

#### 数据包类型
```python
class PackType(Enum):
    grid_data = "grid_data"
    config_data = "config_data"
    runtime_data = "runtime_data"
    reset_env = "reset_env"  # 新增重置命令类型
```

### 错误处理

#### 异常捕获
- Unity连接异常
- AirSim API调用异常
- 数据清理异常
- 无人机初始化异常

#### 日志输出
```
[重置] 用户点击了重置仿真按钮
[步骤1] 发送重置命令到Unity...
[步骤2] 重置AirSim模拟器...
[步骤3] 清理本地数据...
[步骤4] 重新初始化无人机...
[步骤5] 发送配置数据到Unity...
✅ 仿真环境重置完成！
```

---

## 🎨 界面设计

### 按钮样式
- **背景色**: RGB(200, 50, 50) - 深红色
- **悬停色**: RGB(255, 100, 100) - 浅红色
- **边框色**: RGB(255, 100, 100) - 红色边框
- **文字色**: 白色
- **字体**: 16px 中文支持字体

### 位置布局
```
┌─────────────────────────────────────┐
│                    [熵值图例]        │
│                    [重置仿真]        │
│                                     │
│  [状态面板]                          │
│                                     │
│                                     │
│                                     │
│                                     │
│  [权重面板]                          │
│  [操作说明]                          │
└─────────────────────────────────────┘
```

---

## 🔍 调试信息

### 重置成功日志
```
==================================================
开始重置仿真环境...
==================================================
[步骤1] 发送重置命令到Unity...
[重置] 已发送环境重置命令到Unity
[步骤2] 重置AirSim模拟器...
模拟器已重置
[步骤3] 清理本地数据...
本地数据清理完成
[步骤4] 重新初始化无人机...
成功连接到AirSim模拟器
[步骤5] 发送配置数据到Unity...
==================================================
✅ 仿真环境重置完成！
==================================================
```

### 重置失败日志
```
[重置] 用户点击了重置仿真按钮
[重置] ❌ 仿真重置失败
重置仿真环境失败: [具体错误信息]
```

---

## 🚀 使用建议

### 最佳实践
1. **定期重置**: 在长时间运行后建议重置环境
2. **异常恢复**: 出现异常时优先尝试重置
3. **实验重启**: 新实验开始前重置环境
4. **状态检查**: 重置后检查无人机状态

### 注意事项
1. **Unity连接**: 确保Unity客户端正常运行
2. **AirSim连接**: 确保AirSim模拟器连接正常
3. **数据备份**: 重置会清理所有运行时数据
4. **初始化时间**: 重置后需要等待重新初始化完成

---

## ✅ 测试验证

### 功能测试清单
- [x] 按钮显示正常
- [x] 鼠标悬停效果
- [x] 点击响应正常
- [x] Unity重置命令发送
- [x] AirSim重置执行
- [x] 本地数据清理
- [x] 无人机重新初始化
- [x] 配置数据重新发送
- [x] 重置完成反馈
- [x] 错误处理机制

### 兼容性测试
- [x] Windows 10/11
- [x] Python 3.8+
- [x] Pygame 2.0+
- [x] Unity 2022.3+
- [x] AirSim 1.8+

---

## 🎉 总结

重置仿真按钮功能已成功实现，提供了完整的仿真环境重置能力：

### 核心价值
- **一键重置**: 简化环境重置操作
- **完整重置**: 涵盖Unity、AirSim和Python端
- **用户友好**: 直观的按钮界面
- **状态反馈**: 详细的操作日志

### 技术优势
- **模块化设计**: 清晰的功能分离
- **错误处理**: 完善的异常捕获
- **通信协议**: 标准化的数据包格式
- **性能优化**: 高效的UI渲染

**现在用户可以通过点击可视化窗口中的"重置仿真"按钮，轻松重置整个仿真环境！** 🎯
