# DQN V2 å¿«é€Ÿå¼€å§‹

æœ€ç®€å•çš„å®ç°ç‰ˆæœ¬ - ä½¿ç”¨Stable-Baselines3è®­ç»ƒAPFæƒé‡

---

## ğŸš€ å¿«é€Ÿå¼€å§‹ï¼ˆ3æ­¥ï¼‰

### æ­¥éª¤1: å®‰è£…ä¾èµ–

```bash
# åŸºç¡€ä¾èµ–
pip install stable-baselines3 torch gym

# å¯é€‰ï¼šå¦‚æœæƒ³è¦è¿›åº¦æ¡ï¼ˆéœ€è¦é¢å¤–ä¾èµ–ï¼‰
# pip install stable-baselines3[extra]
```

**æ³¨æ„**: å½“å‰ç‰ˆæœ¬å·²ç¦ç”¨è¿›åº¦æ¡ï¼Œæ— éœ€å®‰è£…é¢å¤–ä¾èµ–ã€‚

### æ­¥éª¤2: è®­ç»ƒæ¨¡å‹

```bash
cd multirotor/DQN
python train_simple.py
```

**é¢„æœŸè¾“å‡º**ï¼š
```
==============================================================
ç®€å•DDPGè®­ç»ƒ - APFæƒé‡å­¦ä¹ 
==============================================================

æ£€æŸ¥ä¾èµ–...
âœ“ PyTorch: 2.x.x
âœ“ Stable-Baselines3å·²å®‰è£…

==============================================================
æ­¥éª¤1: åˆ›å»ºè®­ç»ƒç¯å¢ƒ
==============================================================
âœ“ ç¯å¢ƒåˆ›å»ºæˆåŠŸ
  è§‚å¯Ÿç©ºé—´: (18,)
  åŠ¨ä½œç©ºé—´: (5,)

==============================================================
æ­¥éª¤2: åˆ›å»ºDDPGæ¨¡å‹
==============================================================
âœ“ DDPGæ¨¡å‹åˆ›å»ºæˆåŠŸ

==============================================================
æ­¥éª¤3: å¼€å§‹è®­ç»ƒ
==============================================================
è®­ç»ƒæ­¥æ•°: 10000
é¢„è®¡æ—¶é—´: çº¦10åˆ†é’Ÿ

[è®­ç»ƒè¿›åº¦æ¡...]

âœ“ è®­ç»ƒå®Œæˆï¼

==============================================================
æ­¥éª¤4: ä¿å­˜æ¨¡å‹
==============================================================
âœ“ æ¨¡å‹å·²ä¿å­˜: models/weight_predictor_simple.zip
```

### æ­¥éª¤3: æµ‹è¯•æ¨¡å‹

```bash
python test_trained_model.py
```

**é¢„æœŸè¾“å‡º**ï¼š
```
==============================================================
æµ‹è¯•è®­ç»ƒå¥½çš„æƒé‡é¢„æµ‹æ¨¡å‹
==============================================================

åŠ è½½æ¨¡å‹: models/weight_predictor_simple.zip
âœ“ æ¨¡å‹åŠ è½½æˆåŠŸ

==============================================================
æµ‹è¯•åœºæ™¯1: éšæœºçŠ¶æ€
==============================================================

æµ‹è¯• 1:
  çŠ¶æ€: pos=(5.2, 3.1, 1.8), entropy=45.3
  é¢„æµ‹æƒé‡:
    Î±1 (æ’æ–¥åŠ›)  = 2.34
    Î±2 (ç†µ)      = 3.12
    Î±3 (è·ç¦»)    = 1.89
    Î±4 (Leader)  = 2.67
    Î±5 (æ–¹å‘)    = 2.45

[æ›´å¤šæµ‹è¯•...]

âœ“ æ¨¡å‹å¯ä»¥æ­£å¸¸é¢„æµ‹æƒé‡
```

---

## ğŸ“ ä»£ç è¯´æ˜

### æ ¸å¿ƒæ–‡ä»¶

#### 1. simple_weight_env.py
**ç¯å¢ƒå®šä¹‰**ï¼š
- çŠ¶æ€ç©ºé—´ï¼š18ç»´ï¼ˆä½ç½®ã€é€Ÿåº¦ã€æ–¹å‘ã€ç†µå€¼ç­‰ï¼‰
- åŠ¨ä½œç©ºé—´ï¼š5ç»´è¿ç»­ï¼ˆ5ä¸ªæƒé‡ç³»æ•°ï¼‰
- å¥–åŠ±å‡½æ•°ï¼šæ¢ç´¢å¥–åŠ± - ç¢°æ’æƒ©ç½š - è¶Šç•Œæƒ©ç½š

**å…³é”®ä»£ç **ï¼š
```python
class SimpleWeightEnv(gym.Env):
    def __init__(self, server=None, drone_name="UAV1"):
        # è§‚å¯Ÿç©ºé—´: 18ç»´
        self.observation_space = spaces.Box(
            low=-100.0, high=100.0, shape=(18,), dtype=np.float32
        )
        
        # åŠ¨ä½œç©ºé—´: 5ä¸ªæƒé‡ [0.1, 10.0]
        self.action_space = spaces.Box(
            low=0.1, high=10.0, shape=(5,), dtype=np.float32
        )
    
    def step(self, action):
        # action = [Î±1, Î±2, Î±3, Î±4, Î±5]
        # è®¾ç½®æƒé‡åˆ°APFç®—æ³•
        # è®¡ç®—å¥–åŠ±
        # è¿”å› next_state, reward, done, info
```

#### 2. train_simple.py
**è®­ç»ƒè„šæœ¬**ï¼š
- åˆ›å»ºç¯å¢ƒ
- åˆ›å»ºDDPGæ¨¡å‹
- è®­ç»ƒ10000æ­¥
- ä¿å­˜æ¨¡å‹

**å…³é”®å‚æ•°**ï¼š
```python
model = DDPG(
    "MlpPolicy",              # å¤šå±‚æ„ŸçŸ¥æœºç­–ç•¥
    env,
    learning_rate=1e-3,       # å­¦ä¹ ç‡
    buffer_size=10000,        # ç»éªŒå›æ”¾ç¼“å†²åŒº
    batch_size=64,            # æ‰¹æ¬¡å¤§å°
    gamma=0.99                # æŠ˜æ‰£å› å­
)
```

#### 3. test_trained_model.py
**æµ‹è¯•è„šæœ¬**ï¼š
- åŠ è½½è®­ç»ƒå¥½çš„æ¨¡å‹
- æµ‹è¯•ä¸åŒåœºæ™¯
- éªŒè¯æƒé‡é¢„æµ‹

---

## ğŸ¯ å½“å‰å®ç°ç‰¹ç‚¹

### ç®€åŒ–è®¾è®¡
- âœ… æ— éœ€çœŸå®serverï¼ˆå¯ä»¥ç‹¬ç«‹è®­ç»ƒï¼‰
- âœ… ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
- âœ… æœ€å°ä¾èµ–
- âœ… å¿«é€ŸéªŒè¯

### æ ¸å¿ƒåŠŸèƒ½
- âœ… 18ç»´çŠ¶æ€ç©ºé—´
- âœ… 5ç»´è¿ç»­åŠ¨ä½œï¼ˆæƒé‡ï¼‰
- âœ… DDPGç®—æ³•
- âœ… å¥–åŠ±å‡½æ•°

### é™åˆ¶
- âš ï¸ å½“å‰ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®ï¼ˆæ— çœŸå®serverï¼‰
- âš ï¸ å¥–åŠ±å‡½æ•°ç®€åŒ–
- âš ï¸ æœªè¿æ¥çœŸå®ä»¿çœŸç¯å¢ƒ

---

## ğŸ”„ ä¸‹ä¸€æ­¥æ‰©å±•

### æ‰©å±•1: è¿æ¥çœŸå®ç¯å¢ƒ

ä¿®æ”¹ `train_simple.py`ï¼š
```python
# å¯¼å…¥AlgorithmServer
from multirotor.AlgorithmServer import MultiDroneAlgorithmServer

# åˆ›å»ºserver
server = MultiDroneAlgorithmServer()
server.start()

# åˆ›å»ºç¯å¢ƒï¼ˆè¿æ¥çœŸå®serverï¼‰
env = SimpleWeightEnv(server=server, drone_name="UAV1")

# è®­ç»ƒï¼ˆä¼šä½¿ç”¨çœŸå®æ•°æ®ï¼‰
model.learn(total_timesteps=10000)
```

### æ‰©å±•2: è½¬æ¢ä¸ºONNX

```python
# å¯¼å‡ºä¸ºONNXï¼ˆéœ€è¦é¢å¤–å®ç°ï¼‰
import torch

# æå–Actorç½‘ç»œ
actor = model.actor

# å¯¼å‡º
dummy_input = torch.randn(1, 18)
torch.onnx.export(
    actor,
    dummy_input,
    "models/weight_predictor.onnx",
    input_names=['state'],
    output_names=['weights']
)
```

### æ‰©å±•3: é›†æˆåˆ°AlgorithmServer

åœ¨ `AlgorithmServer.py` ä¸­æ·»åŠ ï¼š
```python
def __init__(self, use_learned_weights=False):
    # ...
    if use_learned_weights:
        self.weight_model = DDPG.load("DQN/models/weight_predictor_simple")

def _get_weights(self, drone_name):
    if self.weight_model:
        state = self._get_state(drone_name)
        weights, _ = self.weight_model.predict(state)
        return weights  # [Î±1, Î±2, Î±3, Î±4, Î±5]
    else:
        # ä½¿ç”¨é…ç½®æ–‡ä»¶æƒé‡
        return [2.0, 2.0, 2.0, 2.0, 2.0]
```

---

## ğŸ§ª éªŒè¯æ¸…å•

### åŸºç¡€éªŒè¯
- [ ] `simple_weight_env.py` å¯ä»¥ç‹¬ç«‹è¿è¡Œ
- [ ] `train_simple.py` å¯ä»¥å®Œæˆè®­ç»ƒ
- [ ] `test_trained_model.py` å¯ä»¥åŠ è½½å’Œæµ‹è¯•æ¨¡å‹
- [ ] æ¨¡å‹æ–‡ä»¶ç”Ÿæˆåœ¨ `models/` ç›®å½•

### åŠŸèƒ½éªŒè¯
- [ ] æ¨¡å‹èƒ½é¢„æµ‹5ä¸ªæƒé‡
- [ ] æƒé‡åœ¨æœ‰æ•ˆèŒƒå›´å†… [0.1, 10.0]
- [ ] ä¸åŒçŠ¶æ€å¾—åˆ°ä¸åŒæƒé‡
- [ ] è®­ç»ƒæ›²çº¿æ”¶æ•›

---

## ğŸ› å¸¸è§é—®é¢˜

### Q: æŠ¥é”™ "You must install tqdm and rich"
A: ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š
```bash
# æ–¹æ¡ˆ1: å®‰è£…é¢å¤–ä¾èµ–ï¼ˆæ¨èï¼‰
pip install tqdm rich

# æ–¹æ¡ˆ2: å·²åœ¨ä»£ç ä¸­ç¦ç”¨è¿›åº¦æ¡ï¼ˆprogress_bar=Falseï¼‰
# æ— éœ€é¢å¤–æ“ä½œ
```

### Q: è®­ç»ƒå¾ˆæ…¢æ€ä¹ˆåŠï¼Ÿ
A: å‡å°‘ `total_timesteps`ï¼Œä¾‹å¦‚æ”¹ä¸º5000æˆ–æ›´å°‘
```python
total_timesteps = 5000  # å‡å°‘åˆ°5000æ­¥
```

### Q: æ¨¡å‹é¢„æµ‹çš„æƒé‡éƒ½ä¸€æ ·ï¼Ÿ
A: å¯èƒ½æ˜¯è®­ç»ƒä¸å……åˆ†ï¼Œå¢åŠ è®­ç»ƒæ­¥æ•°æˆ–è°ƒæ•´å­¦ä¹ ç‡
```python
total_timesteps = 20000  # å¢åŠ è®­ç»ƒæ­¥æ•°
```

### Q: å¦‚ä½•æŸ¥çœ‹è®­ç»ƒè¿›åº¦ï¼Ÿ
A: è§‚å¯Ÿæ§åˆ¶å°è¾“å‡ºï¼Œæ¯10ä¸ªepisodeä¼šæ˜¾ç¤ºï¼š
```
---------------------------------
| rollout/            |         |
|    ep_len_mean      | 200     |
|    ep_rew_mean      | 5.23    |
| time/               |         |
|    episodes         | 10      |
|    fps              | 245     |
|    total_timesteps  | 2000    |
---------------------------------
```

### Q: å¦‚ä½•è°ƒæ•´è®­ç»ƒå‚æ•°ï¼Ÿ
A: ä¿®æ”¹ `train_simple.py` ä¸­çš„DDPGå‚æ•°ï¼š
```python
model = DDPG(
    ...,
    learning_rate=1e-4,    # é™ä½å­¦ä¹ ç‡
    batch_size=128,        # å¢å¤§æ‰¹æ¬¡
    buffer_size=50000      # å¢å¤§ç¼“å†²åŒº
)
```

### Q: è®­ç»ƒæ—¶CPUå ç”¨å¾ˆé«˜ï¼Ÿ
A: è¿™æ˜¯æ­£å¸¸çš„ï¼Œè®­ç»ƒéœ€è¦è®¡ç®—èµ„æºã€‚å¯ä»¥ï¼š
- å‡å°‘batch_size
- é™ä½è®­ç»ƒé¢‘ç‡
- æˆ–åœ¨GPUæœºå™¨ä¸Šè®­ç»ƒ

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### è®­ç»ƒåçš„æ¨¡å‹åº”è¯¥èƒ½ï¼š
- âœ… åœ¨é«˜ç†µå€¼åŒºåŸŸï¼šæé«˜Î±2ï¼ˆç†µæƒé‡ï¼‰
- âœ… åœ¨ä½ç†µå€¼åŒºåŸŸï¼šæé«˜Î±3ï¼ˆè·ç¦»æƒé‡ï¼‰
- âœ… é è¿‘å…¶ä»–æ— äººæœºï¼šæé«˜Î±1ï¼ˆæ’æ–¥åŠ›æƒé‡ï¼‰
- âœ… è¿œç¦»Leaderï¼šæé«˜Î±4ï¼ˆLeaderèŒƒå›´æƒé‡ï¼‰
- âœ… è¿åŠ¨ä¸ç¨³å®šï¼šæé«˜Î±5ï¼ˆæ–¹å‘ä¿æŒæƒé‡ï¼‰

### æ€§èƒ½æŒ‡æ ‡
- è®­ç»ƒæ—¶é—´ï¼šçº¦10åˆ†é’Ÿï¼ˆ10000æ­¥ï¼‰
- æ¨¡å‹å¤§å°ï¼šçº¦5MB
- æ¨ç†é€Ÿåº¦ï¼š<10msï¼ˆCPUï¼‰

---

## ğŸ“ å­¦ä¹ èµ„æº

### Stable-Baselines3æ–‡æ¡£
- [DDPGç®—æ³•](https://stable-baselines3.readthedocs.io/en/master/modules/ddpg.html)
- [è‡ªå®šä¹‰ç¯å¢ƒ](https://stable-baselines3.readthedocs.io/en/master/guide/custom_env.html)

### ä»£ç ç¤ºä¾‹
- [Gymç¯å¢ƒæ•™ç¨‹](https://www.gymlibrary.dev/content/environment_creation/)
- [DDPGè®­ç»ƒç¤ºä¾‹](https://github.com/DLR-RM/stable-baselines3/blob/master/docs/guide/examples.rst)

---

## ğŸ’¡ æç¤º

1. **å…ˆç‹¬ç«‹è®­ç»ƒ**ï¼šä¸è¿æ¥serverï¼Œä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®å¿«é€ŸéªŒè¯
2. **è§‚å¯Ÿæƒé‡å˜åŒ–**ï¼šçœ‹æ¨¡å‹æ˜¯å¦å­¦åˆ°äº†åˆç†çš„ç­–ç•¥
3. **é€æ­¥é›†æˆ**ï¼šå…ˆæµ‹è¯•ï¼Œå†é›†æˆåˆ°çœŸå®ç¯å¢ƒ
4. **ä¿å­˜æ£€æŸ¥ç‚¹**ï¼šè®­ç»ƒè¿‡ç¨‹ä¸­å®šæœŸä¿å­˜æ¨¡å‹

---

**åˆ›å»ºæ—¥æœŸ**: 2025-10-13  
**éš¾åº¦**: â­â­ (ç®€å•)  
**é¢„è®¡æ—¶é—´**: 30åˆ†é’Ÿ

