# DQN V2版本需求文档

**状态**: 📝 规划中  
**创建日期**: 2025-10-13  
**负责人**: 待定

---

## 🎯 项目目标

### 核心目标
1. **学习最优APF权重系数**：使用强化学习自动找到最优的5个权重系数（α1-α5）
2. **离线训练+在线推理**：训练在GPU环境，推理在目标机器（AMD 6800H无独显）
3. **轻量级部署**：使用ONNX Runtime，确保CPU占用<15%，推理延迟<50ms
4. **性能提升**：相比固定权重，扫描效率提升至少10%

### 解决V1的问题
- ✅ 不在仿真环境中实时训练（避免卡顿）
- ✅ 学习目标明确（权重而非动作）
- ✅ 使用DDPG而非DQN（适合连续空间）
- ✅ ONNX部署（无PyTorch依赖）

---

## 📋 需求清单

### 功能需求

#### FR1: 核心功能
*[描述核心功能需求]*

#### FR2: 集成方式
*[描述如何与现有系统集成]*

#### FR3: 训练流程

*[描述训练流程]*

#### FR4: 部署方式
*[描述如何部署到目标环境]*

### 非功能需求

#### NFR1: 性能要求
- [ ] CPU占用率 < 15%
- [ ] 内存占用 < 200MB
- [ ] 响应延迟 < 100ms
- [ ] 不影响仿真实时性

#### NFR2: 硬件兼容性
- [ ] 支持无独显环境
- [ ] AMD集成显卡兼容
- [ ] CPU推理优化

#### NFR3: 可维护性
- [ ] 代码模块化
- [ ] 完整文档
- [ ] 单元测试覆盖

---

## 🏗️ 技术方案

### 方案选择

#### ✅ 选项A: 离线训练 + 在线推理（已选择）

**优点**:
- 训练在GPU机器上进行
- 推理开销小（ONNX Runtime）
- 稳定可靠
- 不影响仿真性能

**缺点**:
- 无法在线学习
- 需要预先训练好

**是否采用**: ✅ 是

#### 选项B: 异步学习
**优点**:
- 可以在线学习
- 独立线程不阻塞主流程

**缺点**:
- 实现复杂
- 仍有性能开销

**是否采用**: ⬜ 否

#### 选项C: 传统优化算法
**是否采用**: ⬜ 否（未来可作为补充方案）

#### 选项D: 混合方法
**是否采用**: ⬜ 否

---

## 📊 状态空间与动作空间

### 状态空间设计

**状态维度**: 18维

```python
state = [
    # 位置信息 (3维)
    position_x, position_y, position_z,
    
    # 速度信息 (3维)
    velocity_x, velocity_y, velocity_z,
    
    # 朝向信息 (3维)
    direction_x, direction_y, direction_z,
    
    # 附近熵值 (3维)
    avg_entropy,    # 平均熵值
    max_entropy,    # 最大熵值
    std_entropy,    # 熵值标准差
    
    # Leader相对位置 (3维)
    relative_x, relative_y, relative_z,
    
    # 扫描进度 (3维)
    scanned_ratio,       # 已扫描比例
    scanned_count,       # 已扫描数量
    unscanned_count      # 未扫描数量
]
```

### 动作空间设计

**动作维度**: 5维连续空间

```python
action = [
    α1,  # repulsionCoefficient      [0.1, 10.0]
    α2,  # entropyCoefficient        [0.1, 10.0]
    α3,  # distanceCoefficient       [0.1, 10.0]
    α4,  # leaderRangeCoefficient    [0.1, 10.0]
    α5,  # directionRetentionCoefficient [0.1, 10.0]
]
```

**动作类型**: 连续动作（DDPG输出）

**输出层**:
```python
# Sigmoid缩放到有效范围
weights = torch.sigmoid(raw_output) * 9.9 + 0.1
```

### 奖励函数设计

```python
reward = (
    # 探索奖励（权重1.0）
    + 1.0 * new_scanned_area +
    + 0.5 * entropy_reduction +
    
    # 效率奖励（权重0.3）
    + 0.3 * scan_efficiency -
    + 0.2 * path_smoothness -
    
    # 安全惩罚（权重5.0）
    - 5.0 * collision_risk -
    - 2.0 * boundary_violation -
    
    # 稳定性（权重0.3）
    + 0.3 * movement_smoothness
)
```

---

## 🔧 技术栈

### 训练环境（GPU机器 / Google Colab）
- [x] Python版本: **3.8+**
- [x] 深度学习框架: **PyTorch 1.9+**
- [x] RL库: **Stable-Baselines3 1.0+**
- [x] 其他依赖: **numpy, pandas, tensorboard**

### 推理环境（目标机器 - AMD 6800H）
- [x] 推理引擎: **ONNX Runtime (CPU)**
- [x] 模型格式: **ONNX (INT8量化)**
- [x] 优化方案: **动态量化、算子融合**

---

## 📅 开发计划

### 阶段1: 设计与原型 (预计__ 周)
- [ ] 完成需求分析
- [ ] 设计技术方案
- [ ] 实现最小原型
- [ ] 性能测试

### 阶段2: 实现与优化 (预计__ 周)
- [ ] 实现完整功能
- [ ] 性能优化
- [ ] 集成测试
- [ ] Bug修复

### 阶段3: 部署与文档 (预计__ 周)
- [ ] 部署到目标环境
- [ ] 编写文档
- [ ] 用户培训
- [ ] 维护支持

---

## ✅ 验收标准

### 功能验收
- [ ] 所有功能需求已实现
- [ ] 通过所有测试用例
- [ ] 无已知严重Bug

### 性能验收
- [ ] 满足所有性能指标
- [ ] 在目标硬件上运行流畅
- [ ] 资源占用在预期范围内

### 文档验收
- [ ] 用户文档完整
- [ ] API文档完整
- [ ] 代码注释充分

---

## 🔄 V1版本总结

### V1的问题
1. ⚠️ PyTorch初始化导致卡顿
2. ⚠️ 实时学习导致CPU占用过高
3. ⚠️ 数据访问时序问题
4. ⚠️ 无独显环境性能不足

### V2改进方向
1. ✅ [改进措施1]
2. ✅ [改进措施2]
3. ✅ [改进措施3]

---

## 📞 联系与协作

### 项目角色
- **产品负责人**: _______
- **技术负责人**: _______
- **开发人员**: _______
- **测试人员**: _______

### 沟通渠道
- 项目仓库: _______
- 讨论组: _______
- 文档: _______

---

## 📚 参考资料

### V1归档文档
- [README_V1_ARCHIVED.md](./README_V1_ARCHIVED.md)
- [CPU_OPTIMIZATION.md](./CPU_OPTIMIZATION.md)

### 学术论文
- *[列出相关论文]*

### 技术博客
- *[列出有用的技术资料]*

### 相关项目
- *[列出类似项目供参考]*

---

**文档更新日期**: 2025-10-13  
**版本**: Draft 1.0

