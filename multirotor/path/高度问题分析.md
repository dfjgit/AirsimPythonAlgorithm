# AirSim 高度偏差问题分析

## 问题现象

高度总是差约 **0.48-0.50米**（几乎是2倍）

```
目标高度(路径坐标): 0.4837m
目标Z(AirSim NED): -0.4837m
实际Z(AirSim NED): -0.9720m
实际高度(转换后): 0.9720m
高度偏差: 0.4884m
```

## 可能的原因

### 1. **AirSim的默认起飞高度**
AirSim的 `takeoffAsync()` 有默认起飞高度，通常约为 **0.5米**

- 起飞前：Z = 0 (地面)
- 起飞后：Z ≈ -0.5 (悬停在0.5米高度)

### 2. **坐标参考点问题**
Path1中的高度（0.48米）可能是：
- **相对地面的高度**：从地面往上0.48米
- 但AirSim起飞后已经在约0.5米高度
- 所以移动到-0.48时，实际是：地面 + 起飞高度(0.5) + 目标(-0.48) ≈ 1.0米

### 3. **坐标系叠加**
```
地面: Z = 0
起飞后: Z = -0.5 (已经离地0.5米)
目标: Z = -0.48
实际到达: 起飞点 + 移动 = -0.5 + (-0.48相对移动) ≈ -1.0
```

## 解决方案

### 方案1: 使用起飞点作为参考（推荐）

修改移动逻辑，考虑起飞后的初始高度：

```python
# 记录起飞后的Z坐标
takeoff_z = pos_after_takeoff.z_val  # 例如 -0.5

# 计算目标Z时，从起飞点开始计算
target_z_airsim = takeoff_z - target_height
# 如果target_height = 0.48，则
# target_z_airsim = -0.5 - 0.48 = -0.98

# 或者使用相对移动
relative_height = target_height - (-takeoff_z)  # 相对起飞点的高度变化
target_z_airsim = takeoff_z + relative_height
```

### 方案2: 使用绝对高度

让Path1的高度就是绝对高度（从地面算起）：

```python
# 目标高度0.48米（从地面）
# 直接转换为NED
target_z_airsim = -0.48  # 期望在地面上0.48米

# 但需要先让无人机降到接近地面，或者
# 使用moveToZAsync指定绝对高度
```

### 方案3: 调整Path1的高度值

如果Path1的高度是想要的离地高度，考虑：

```python
# 如果想要离地0.48米
# 需要减去起飞高度
adjusted_height = target_height - takeoff_height
# 0.48 - 0.5 = -0.02 (几乎在起飞点)

# 或者如果Path1高度已经考虑了起飞，则直接使用
```

## 诊断步骤

运行诊断脚本：
```bash
python diagnose_height.py
```

这会检查：
1. 起飞前的位置
2. 起飞后的位置（获取默认起飞高度）
3. 移动到目标高度后的实际位置
4. 偏差分析

## 建议

1. **先运行诊断脚本**，确认AirSim的起飞高度
2. **修改代码**，使用起飞点作为参考基准
3. **或者修改Path1.json**，调整高度值以匹配预期

## 代码示例（修复方案）

```python
class PathFlightController:
    def __init__(self):
        self.takeoff_z = 0.0  # 记录起飞后的Z坐标
        
    def connect_and_setup(self):
        # ... 起飞 ...
        state = self.client.getMultirotorState()
        self.takeoff_z = state.kinematics_estimated.position.z_val
        logger.info(f"起飞基准Z: {self.takeoff_z:.4f}")
        
    def fly_straight_with_sampling(self, path_points, path_name):
        # 方案1: 使用相对起飞点的高度
        start_z = path_points[0]['z']
        # 如果path的z是相对地面，需要从起飞点开始计算
        start_airsim_z = self.takeoff_z - start_z
        
        # 方案2: 如果path的z已经是绝对高度，直接使用
        # start_airsim_z = -start_z
```

