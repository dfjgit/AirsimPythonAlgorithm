# 权重平衡机制说明

解决DQN预测权重失衡导致的行为异常问题

---

## 🐛 问题描述

### 症状
- 无人机一直往一个方向飞
- 某个权重值过高（如α2=9.5，其他都是1.0）
- 行为不稳定，忽略其他因素

### 原因
DQN模型可能学习到极端的权重组合，导致：
- 某个权重占主导地位
- APF算法失衡
- 无人机行为异常

---

## ✅ 解决方案

### 1. 缩小权重范围

**之前**：[0.1, 10.0] - 范围过大（100倍差异）

**现在**：[0.5, 5.0] - 合理范围（10倍差异）

```python
# 动作空间
self.action_space = spaces.Box(
    low=0.5,   # 最小权重
    high=5.0,  # 最大权重
    shape=(5,),
    dtype=np.float32
)
```

### 2. 软归一化

**目的**：限制权重之间的差异

```python
action_mean = np.mean(action)
action_std = np.std(action)

# 如果标准差过大（>1.5），进行平滑
if action_std > 1.5:
    # 将极端值拉回到均值附近（保留70%的差异）
    action = action_mean + (action - action_mean) * 0.7
    action = np.clip(action, 0.5, 5.0)
```

**效果**：
```
之前: [1.0, 9.5, 1.2, 1.1, 1.0]  # α2过高
      mean=2.96, std=3.36

平滑后: [1.88, 5.54, 2.13, 1.98, 1.88]  # 更平衡
       mean=2.68, std=1.47
```

### 3. 比例限制

**目的**：确保最大权重不会过度压制其他权重

```python
min_weight = np.min(action)
max_weight = np.max(action)

# 最大值不超过最小值的5倍
if max_weight > min_weight * 5:
    scale = (min_weight * 5) / max_weight
    action = action * scale
    action = np.clip(action, 0.5, 5.0)
```

**效果**：
```
之前: [0.8, 5.0, 1.0, 1.2, 0.9]  # max/min = 6.25倍
比例限制后: [0.8, 4.0, 1.0, 1.2, 0.9]  # max/min = 5倍
```

---

## 📊 权重平衡流程

```
模型输出原始权重
    ↓
范围裁剪 [0.5, 5.0]
    ↓
计算均值和标准差
    ↓
标准差 > 1.5?
    ├─ 是 → 软归一化（拉回均值）
    └─ 否 → 继续
    ↓
计算最大/最小比例
    ↓
比例 > 5?
    ├─ 是 → 缩放权重
    └─ 否 → 继续
    ↓
最终平衡权重
    ↓
应用到APF算法
```

---

## 🎯 参数调优

### 调整平衡强度

**更激进的平衡**（权重更接近）：
```python
# 降低标准差阈值
if action_std > 1.0:  # 从1.5改为1.0

# 增强平滑
action = action_mean + (action - action_mean) * 0.5  # 从0.7改为0.5

# 降低比例限制
if max_weight > min_weight * 3:  # 从5改为3
```

**更宽松的平衡**（允许更大差异）：
```python
# 提高标准差阈值
if action_std > 2.0:  # 从1.5改为2.0

# 减弱平滑
action = action_mean + (action - action_mean) * 0.9  # 从0.7改为0.9

# 提高比例限制
if max_weight > min_weight * 8:  # 从5改为8
```

### 调整权重范围

**更保守的范围**：
```python
low=1.0,   # 从0.5改为1.0
high=3.0,  # 从5.0改为3.0
```

**更激进的范围**：
```python
low=0.1,   # 从0.5改为0.1
high=8.0,  # 从5.0改为8.0
```

---

## 🔍 调试建议

### 查看权重日志

在AlgorithmServer日志中查看：
```
预测权重(平衡后): {
    'repulsionCoefficient': 2.34,
    'entropyCoefficient': 3.12,
    'distanceCoefficient': 1.89,
    'leaderRangeCoefficient': 2.67,
    'directionRetentionCoefficient': 2.45
}
```

### 观察可视化面板

**左下角DQN权重面板**：
- 查看权重条长度
- 观察颜色变化
- 确认权重平衡

**正常情况**：
- 权重条长度相近
- 大部分是绿色或黄色
- 很少出现红色（过高）

**异常情况**：
- 某个权重条特别长（红色）
- 其他权重条很短（绿色）
- 需要调整平衡参数

---

## 📈 效果对比

### 平衡前
```
权重: [0.8, 9.2, 1.1, 1.0, 0.9]
行为: 只关注熵值，忽略避障和Leader
结果: 一直往高熵区域飞，可能碰撞或越界
```

### 平衡后
```
权重: [1.5, 3.8, 1.8, 2.0, 1.6]
行为: 平衡考虑探索、避障、跟随
结果: 稳定飞行，合理探索
```

---

## 🎓 设计原理

### 为什么需要平衡？

1. **APF算法特性**：
   - 最终方向 = Σ(权重 × 单位向量)
   - 权重差异过大会压制其他方向
   - 需要保持相对平衡

2. **训练不充分**：
   - 模型可能还在探索
   - 早期训练可能产生极端值
   - 需要后处理保护

3. **安全考虑**：
   - 避免极端行为
   - 确保基本功能（避障、跟随）
   - 提供降级保护

### 平衡 vs 限制

**硬限制**（不推荐）：
```python
# 所有权重强制在[1.5, 2.5]
action = np.clip(action, 1.5, 2.5)
```
- ❌ 失去模型的自适应能力
- ❌ 所有场景都一样

**软平衡**（推荐，当前方案）：
```python
# 保留相对差异，但限制极端情况
if action_std > 1.5:
    action = action_mean + (action - action_mean) * 0.7
```
- ✅ 保留模型的判断
- ✅ 避免极端情况
- ✅ 自适应 + 安全

---

## 🔧 实施位置

### 文件1: simple_weight_env.py
- 训练环境中的权重处理
- 影响训练过程

### 文件2: AlgorithmServer.py
- 实际运行时的权重处理
- 影响部署效果

### 文件3: simple_visualizer.py
- 可视化显示范围调整
- 权重条颜色阈值

---

## 💡 未来改进

### 方案1: 自适应阈值
根据场景动态调整平衡参数

### 方案2: 权重约束训练
在训练时就加入权重平衡的约束

### 方案3: 多目标优化
同时优化性能和权重平衡性

---

**创建日期**: 2025-10-13  
**版本**: 1.0

