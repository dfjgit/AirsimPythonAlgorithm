# 📏 距离系数（Distance Coefficient）详解

## 📋 概述

距离系数（`distanceCoefficient`）是APF（人工势场）算法中的一个关键参数，用于控制无人机选择目标时**距离远近的重要性**。

---

## 🎯 在算法中的位置

### APF五大方向分量

```
最终方向 = α1·排斥方向 + α2·熵值方向 + α3·路径方向 + α4·Leader方向 + α5·方向保持
         ↑           ↑           ↑ 距离系数      ↑            ↑
      排斥系数     熵值系数      影响这个       Leader      方向保持
                                              系数        系数
```

**距离系数控制的是"路径方向"（Path Direction）的权重**。

---

## 💡 核心概念

### 什么是路径方向？

在代码中：
```python
def calculate_path_direction(self, score_dir: Vector3) -> Vector3:
    """计算最短路径方向向量"""
    return ensure_unity_coordinates(score_dir)
```

**关键点**：
- 路径方向 = 分数方向（Score Direction）
- 它指向算法选中的**最佳候选目标**
- 这个目标是基于**熵值和距离**综合评分选出的

---

## 🔍 距离如何影响目标选择

### 候选目标评分公式

```python
# 在 calculate_score_direction() 方法中：

for cell in candidate_cells:
    distance = (cell_center - current_pos).magnitude()
    
    # 1. 距离归一化 (0-1)
    normalized_distance = min(1.0, max(0.0, 1 - (distance / targetSearchRange)))
    
    # 2. 熵值归一化 (0-1)
    entropy_score = (cell.entropy - min_entropy) / entropy_range
    
    # 3. 综合评分（熵值70%，距离30%）
    total_score = entropy_score * 0.7 + normalized_distance * 0.3
```

**评分规则**：
- ✅ **熵值高** → 分数高（信息量大，更需要扫描）
- ✅ **距离近** → 分数高（容易到达）
- ✅ 熵值占70%，距离占30%

---

## 📊 距离归一化详解

### 公式分析

```python
normalized_distance = 1 - (distance / targetSearchRange)
```

**举例说明**（假设 `targetSearchRange = 20.0`）：

| 实际距离 | 计算过程 | 归一化距离 | 含义 |
|---------|---------|-----------|------|
| 0m | 1 - (0/20) | 1.0 | 最近，满分 |
| 5m | 1 - (5/20) | 0.75 | 很近，高分 |
| 10m | 1 - (10/20) | 0.50 | 中等距离 |
| 15m | 1 - (15/20) | 0.25 | 较远，低分 |
| 20m | 1 - (20/20) | 0.0 | 搜索边界，最低分 |
| >20m | - | 0.0 | 超出范围，不考虑 |

**特点**：
- 距离越近，分数越高
- 线性衰减（不是指数衰减）
- 超出搜索范围的目标直接忽略

---

## ⚖️ 距离系数的作用

### 权重归一化

```python
def calculate_proportional_weights(self):
    total = (repulsionCoefficient + 
             entropyCoefficient + 
             distanceCoefficient + 
             leaderRangeCoefficient + 
             directionRetentionCoefficient)
    
    distance_weight = distanceCoefficient / total
    return (..., distance_weight, ...)
```

### 合并方向向量

```python
def merge_directions(self, score_dir, path_dir, ...):
    final_move_dir = (
        score_dir * entropy_weight +
        path_dir * distance_weight +      # ← 距离系数在这里发挥作用
        collide_dir * repulsion_weight +
        leader_range_dir * leader_range_weight +
        direction_retention_dir * direction_retention_weight
    )
```

**实际效果**：
- `distanceCoefficient` **越大** → 路径方向（指向目标）的影响力越大
- `distanceCoefficient` **越小** → 其他方向（排斥、Leader等）的影响力相对增强

---

## 🎲 参数配置

### 默认配置（scanner_config.json）

```json
{
    "distanceCoefficient": 2.0,
    "targetSearchRange": 20.0
}
```

### 典型配置范围

| 参数 | 典型值 | 作用 |
|------|-------|------|
| `distanceCoefficient` | 0.5 - 5.0 | 路径方向权重 |
| `targetSearchRange` | 10.0 - 30.0 | 搜索范围（米） |

---

## 📈 不同系数值的影响

### 场景1：distanceCoefficient = 0.5（低值）

```python
权重分布（假设其他系数都是2.0）：
total = 0.5 + 2.0 + 2.0 + 2.0 + 2.0 = 8.5
distance_weight = 0.5 / 8.5 = 0.059 (5.9%)
```

**效果**：
- ❌ 路径方向影响力很小
- ✅ 无人机更容易被排斥力、Leader范围等因素"拉"走
- ✅ 更注重避障和跟随Leader
- ⚠️ 可能频繁改变目标，效率降低

### 场景2：distanceCoefficient = 2.0（默认）

```python
权重分布（所有系数都是2.0）：
total = 2.0 + 2.0 + 2.0 + 2.0 + 2.0 = 10.0
distance_weight = 2.0 / 10.0 = 0.20 (20%)
```

**效果**：
- ✅ 五个方向平衡
- ✅ 既考虑目标，又考虑避障和约束
- ✅ 适合大多数场景

### 场景3：distanceCoefficient = 5.0（高值）

```python
权重分布（假设其他系数都是2.0）：
total = 5.0 + 2.0 + 2.0 + 2.0 + 2.0 = 13.0
distance_weight = 5.0 / 13.0 = 0.385 (38.5%)
```

**效果**：
- ✅ 路径方向影响力很大
- ✅ 无人机更坚定地朝目标移动
- ⚠️ 可能忽视部分避障和Leader约束
- ⚠️ 在复杂环境中可能过于"激进"

---

## 🔬 实验对比

### 测试场景

假设无人机面对以下情况：
- 前方20米有高熵值目标A（entropy=90）
- 右侧5米有中熵值目标B（entropy=60）
- 左侧有其他无人机（需要排斥）

### distanceCoefficient = 0.5

```
计算过程：
目标A评分 = 0.9*0.7 + 0.0*0.3 = 0.63  (远但熵值高)
目标B评分 = 0.6*0.7 + 0.75*0.3 = 0.645 (近但熵值中等)

选择：目标B（距离优势）
方向：→ 右侧
权重：5.9%

最终结果：排斥力影响大，可能向左偏移，效率低
```

### distanceCoefficient = 2.0

```
选择：目标B
方向：→ 右侧
权重：20%

最终结果：平衡各方向，稳定前进
```

### distanceCoefficient = 5.0

```
选择：目标B
方向：→ 右侧
权重：38.5%

最终结果：快速朝目标前进，可能忽略轻微排斥
```

---

## 🎯 使用建议

### 根据场景选择系数

| 场景 | 推荐值 | 理由 |
|------|-------|------|
| **开阔环境** | 3.0 - 5.0 | 障碍少，可以大胆前进 |
| **密集障碍** | 1.0 - 2.0 | 需要更注重避障 |
| **多无人机协同** | 1.5 - 2.5 | 平衡目标和排斥 |
| **严格Leader约束** | 1.0 - 2.0 | 确保不脱离Leader范围 |

### 调试建议

1. **起始值**：从默认的2.0开始
2. **观察行为**：
   - 无人机是否坚定朝目标移动？
   - 是否频繁改变方向？
   - 避障效果如何？
3. **逐步调整**：
   - 太犹豫 → 增大系数
   - 太激进 → 减小系数

---

## 🔗 与其他系数的关系

### 互补关系

```
距离系数 ↔ 熵值系数
- 都影响目标选择
- 距离系数放大"路径方向"的权重
- 熵值系数已经在目标评分时占70%

距离系数 ↔ 排斥系数
- 相互制衡
- 距离系数拉向目标
- 排斥系数推离障碍

距离系数 ↔ Leader系数
- 相互制衡
- 距离系数：自主探索
- Leader系数：约束范围
```

### 典型配置组合

**保守型**（安全第一）：
```json
{
    "repulsionCoefficient": 3.0,
    "entropyCoefficient": 2.0,
    "distanceCoefficient": 1.5,
    "leaderRangeCoefficient": 2.5,
    "directionRetentionCoefficient": 1.0
}
```

**平衡型**（默认）：
```json
{
    "repulsionCoefficient": 2.0,
    "entropyCoefficient": 2.0,
    "distanceCoefficient": 2.0,
    "leaderRangeCoefficient": 2.0,
    "directionRetentionCoefficient": 2.0
}
```

**激进型**（效率优先）：
```json
{
    "repulsionCoefficient": 1.5,
    "entropyCoefficient": 3.0,
    "distanceCoefficient": 3.5,
    "leaderRangeCoefficient": 1.0,
    "directionRetentionCoefficient": 2.0
}
```

---

## 🧪 DQN训练中的应用

在DQN权重训练中，距离系数是5个可学习参数之一：

```python
# simple_weight_env.py
action_space = Box(
    low=np.array([0.5, 0.5, 0.5, 0.5, 0.5]),
    high=np.array([5.0, 5.0, 5.0, 5.0, 5.0]),
    dtype=np.float32
)
# action[0] = repulsionCoefficient
# action[1] = entropyCoefficient
# action[2] = distanceCoefficient  ← 距离系数
# action[3] = leaderRangeCoefficient
# action[4] = directionRetentionCoefficient
```

**DQN的学习目标**：
- 根据当前环境状态
- 动态调整距离系数
- 优化扫描效率和覆盖率

---

## 📚 总结

### 关键点回顾

1. **定义**：控制无人机朝向选定目标移动的权重
2. **作用机制**：通过权重归一化影响路径方向的比例
3. **与距离的关系**：
   - 目标选择时：距离近的候选目标得分高（占30%）
   - 方向合并时：距离系数决定路径方向的权重
4. **典型值**：0.5 - 5.0，默认2.0
5. **调整原则**：
   - 开阔环境 → 增大
   - 密集障碍 → 减小
   - 平衡各因素 → 默认值

### 公式速查

```
目标评分 = 熵值归一化 × 0.7 + 距离归一化 × 0.3
距离归一化 = 1 - (实际距离 / 搜索范围)
距离权重 = distanceCoefficient / (所有系数之和)
最终方向 = Σ(各方向 × 对应权重)
```

---

## 🔧 实用工具

### 可视化查看当前系数

运行系统时，可视化窗口的**权重面板**会实时显示：

```
⚙️ 当前APF权重
━━━━━━━━━━━━━━━━━━━━━━
α1 排斥:  2.00  ████████░░░░
α2 熵值:  2.00  ████████░░░░
α3 距离:  2.00  ████████░░░░  ← 这就是距离系数
α4 Leader: 2.00  ████████░░░░
α5 方向:  2.00  ████████░░░░
```

### 修改配置

```bash
# 编辑配置文件
nano AirsimAlgorithmPython/multirotor/scanner_config.json

# 修改距离系数
"distanceCoefficient": 3.0  # 从2.0改为3.0

# 重启系统生效
```

---

希望这个详解能帮助你理解距离系数的计算和作用！🚀

